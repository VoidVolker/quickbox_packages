#!/bin/bash
#
# [Quick Box :: EcoSystem Update Script]
#
# GitHub:   https://github.com/QuickBox/quickbox_packages
# Author:   QuickBox.io
# URL:      https://plaza.quickbox.io
#
# QuickBox Copyright (C) 2016 Swizards.net
# Licensed under GNU General Public License v3.0 GPL-3 (in short)
#
#   You may copy, distribute and modify the software as long as you track
#   changes/dates in source files. Any modifications to our software
#   including (via compiler) GPL-licensed code must also be made available
#   under the GPL along with build & install instructions.
#
#################################################################################
function _string() { perl -le 'print map {(a..z,A..Z,0..9)[rand 62] } 0..pop' 15 ; }
#################################################################################

function _logcheck() {
  OUTTO=/srv/rutorrent/home/db/output.log
}

function _downloadrepos() {
  echo >>"${OUTTO}" 2>&1;
  echo -n "quickbox_setup              :: " >>"${OUTTO}" 2>&1;
    cd ${local_setup} && git checkout master
    git pull >>"${OUTTO}" 2>&1;
  echo -n "quickbox_rutorrent          :: " >>"${OUTTO}" 2>&1;
    cd ${local_rutorrent} && git checkout master
    git pull >>"${OUTTO}" 2>&1;
  echo -n "quickbox_rutorrent-plugins  :: " >>"${OUTTO}" 2>&1;
    cd ${local_rplugins} && git checkout master
    git pull >>"${OUTTO}" 2>&1;
  echo -n "quickbox_packages           :: " >>"${OUTTO}" 2>&1;
    cd ${local_packages} && git checkout master
    git pull >>"${OUTTO}" 2>&1;
  echo -n "quickbox_dashboard          :: " >>"${OUTTO}" 2>&1;
    cd ${local_dashboard} && git checkout master
    git pull >>"${OUTTO}" 2>&1;
}

function _bashrc() {
  cp ${local_setup}templates/bashrc.template /root/.bashrc
}

function _updatesyscommands() {
  cd ${usrbin}
  cp -R ${local_packages}. ${usrbin}quickbox
}

function _updateskel() {
  if [[ -d /etc/skel ]]; then
    rm -r /etc/skel
  fi
  mkdir /etc/skel
  cp -r ${local_setup}templates/skel/. /etc/skel
}

function _updaterutorrent() {
  cd /srv
  cp -R ${local_rutorrent}. rutorrent
}

function _updaterutorrent-plugins() {
  cd ${rutorrent}
  cp -R ${local_rplugins}. plugins
}

# function to install dashboard (23)
function _updatedashboard() {
  cd ${rutorrent}
  cp -R ${local_dashboard}. ${rutorrent}home
}

function _updatesudo() {
  rm /etc/sudoers
  cp ${local_setup}templates/sudoers.template /etc/sudoers
  awk -v username="${A1}" '/^root/ && !x {print username    " ALL=(ALL:ALL) NOPASSWD: ALL"; x=1} 1' /etc/sudoers > /tmp/sudoers;mv /tmp/sudoers /etc
}

function _updatecronfile() {
  cp ${local_setup}templates/startup.template /home/"${A1}"/.startup
}

# adjust permissions function (9)
function _perms() {
  chown -R www-data /srv/rutorrent/*
  chgrp -R www-data /srv/rutorrent/*
  chmod -R g+rw /srv/rutorrent/*
  sh -c 'find /srv/rutorrent/* -type d -print0 | sudo xargs -0 chmod g+s'
  chmod +x /etc/cron.d/set_interface
  chmod +x /home/"${A1}"/.startup
}

function _fin() {
  echo
  echo "[QuickBox] Seddbox & GUI Update Completed ! " >>"${OUTTO}" 2>&1;
  sleep 5
  echo "Refreshing your browser in 5 seconds" >>"${OUTTO}" 2>&1;
  sleep 5
  printf "" > /srv/rutorrent/home/db/output.log

  exit
}

clear

local_setup=/root/QuickBox/setup/
local_packages=/root/QuickBox/packages/
local_rutorrent=/root/QuickBox/rutorrent/
local_rplugins=/root/QuickBox/rtplugins/
local_dashboard=/root/QuickBox/dashboard/

Reth0=$(ifconfig | grep -m 1 "Link encap" | sed 's/[ \t].*//;/^\(lo\|\)$/d' | awk '{ print $1 '});
IFACE=$(echo -n "${Reth0}");
A1=$(cat /srv/rutorrent/home/db/master.txt) >> /dev/null 2>&1
rutorrent=/srv/rutorrent/
usrbin=/usr/local/bin/

# QuickBox Update STRUCTURE
_logcheck
#echo -n "Setting up git stash for saved changes ... " >>"${OUTTO}" 2>&1;_setstash
echo -n "Pulling QuickBox Ecosystem ... " >>"${OUTTO}" 2>&1;_downloadrepos;echo
_bashrc
echo -n "Updating QuickBox System Commands & Packages ... " >>"${OUTTO}" 2>&1;_updatesyscommands
echo -n "Updating the useradd skeleton directories ... " >>"${OUTTO}" 2>&1;_updateskel
#echo -n "Looking for install directory for .lock files ... " >>"${OUTTO}" 2>&1;_installdir
echo -n "Updating the rutorrent directory ... " >>"${OUTTO}" 2>&1;_updaterutorrent
echo -n "Updating the QuickBox Dashboard ... " >>"${OUTTO}" 2>&1;_updatedashboard
echo -n "Updating the QuickBox Sudoers template ... " >>"${OUTTO}" 2>&1;_updatesudo
echo -n "Updating ${A1}'s .startup cronfile... " >>"${OUTTO}" 2>&1;_updatecronfile
echo -n "Adjusting permissions ... " >>"${OUTTO}" 2>&1;_perms
_fin
